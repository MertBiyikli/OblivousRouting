name: Oblivious Routing CI

on:
  push:
    branches: [ master ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  # ================================================================
  # 1) DOCKER IMAGE BUILD + PUSH (your original job)
  # ================================================================
  build-docker:
    name: Docker Image
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image with caching
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ghcr.io/mertbiyikli/oblivousrouting:latest
            ghcr.io/mertbiyikli/oblivousrouting:${{ github.sha }}
            ghcr.io/mertbiyikli/oblivousrouting:${{ github.ref_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max


  # ================================================================
  # 2) NATIVE LINUX BUILD (with Boost + OR-Tools)
  # ================================================================
  build-linux:
    name: Native Linux Build
    runs-on: ubuntu-24.04
    needs: build-docker

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build git pkg-config \
                                   libboost-all-dev libeigen3-dev wget unzip

      # --- Cache OR-Tools ---
      - name: Cache OR-Tools
        id: cache-ortools
        uses: actions/cache@v4
        with:
          path: ortools-install
          key: ortools-v9.6-${{ runner.os }}-${{ hashFiles('CMakeLists.txt') }}

      - name: Install OR-Tools if cache miss
        if: steps.cache-ortools.outputs.cache-hit != 'true'
        run: |
          echo "Installing OR-Tools v9.6..."
          wget --header="User-Agent: Mozilla/5.0" \
          https://github.com/google/or-tools/releases/download/v9.6/or-tools_x86_64_ubuntu-22.04_cpp_v9.6.2534.zip
          unzip or-tools_x86_64_ubuntu-22.04_cpp_v9.6.2534.zip
          mv or-tools_x86_64_ubuntu-22.04_cpp_v9.6.2534 ortools-install

      - name: Build
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release \
                -Dortools_DIR=ortools-install/lib/cmake/ortools
          cmake --build build --target oblivious_routing -j$(nproc)

      - name: Upload Linux Binary
        uses: actions/upload-artifact@v4
        with:
          name: oblivious_routing-linux
          path: build/oblivious_routing
          retention-days: 30


  # ================================================================
  # 3) macOS BUILD
  # ================================================================
  build-macos:
    name: macOS Native Build
    runs-on: macos-13
    needs: build-docker

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install deps
        run: |
          brew install cmake boost eigen or-tools

      - name: Build
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --target oblivious_routing -j4

      - name: Upload macOS Binary
        uses: actions/upload-artifact@v4
        with:
          name: oblivious_routing-macos
          path: build/oblivious_routing
          retention-days: 30


  # ================================================================
  # 4) WINDOWS BUILD (.exe)
  # ================================================================
  build-windows:
    name: Windows Native Build
    runs-on: windows-latest
    needs: build-docker

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install vcpkg + deps
        shell: pwsh
        run: |
          $VCPKG = Join-Path $env:USERPROFILE "vcpkg"
          git clone https://github.com/microsoft/vcpkg $VCPKG
          & "$VCPKG\bootstrap-vcpkg.bat"
          & "$VCPKG\vcpkg" install boost:x64-windows eigen3:x64-windows ortools:x64-windows
      

      - name: Configure
        shell: pwsh
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release `
                -DCMAKE_TOOLCHAIN_FILE=$env:USERPROFILE/vcpkg/scripts/buildsystems/vcpkg.cmake

      - name: Build
        shell: pwsh
        run: |
          cmake --build build --target oblivious_routing --config Release -j4

      - name: Upload Windows EXE
        uses: actions/upload-artifact@v4
        with:
          name: oblivious_routing-windows
          path: build/Release/oblivious_routing.exe
          retention-days: 30


  # ================================================================
  # 5) OPTIONAL: CREATE GITHUB RELEASE WHEN TAGGING
  # ================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos, build-windows]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all binaries
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            oblivious_routing-linux/oblivious_routing
            oblivious_routing-macos/oblivious_routing
            oblivious_routing-windows/oblivious_routing.exe
