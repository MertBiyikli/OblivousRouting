name: Oblivious Routing CI

on:
  push:
    branches: [ master ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  # ================================================================
  # 1) DOCKER IMAGE BUILD + PUSH (your original job)
  # ================================================================
  build-docker:
    name: Docker Image
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image with caching
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ghcr.io/mertbiyikli/oblivousrouting:latest
            ghcr.io/mertbiyikli/oblivousrouting:${{ github.sha }}
            ghcr.io/mertbiyikli/oblivousrouting:${{ github.ref_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max


  # ================================================================
  # 2) NATIVE LINUX BUILD (with Boost + OR-Tools)
  # ================================================================
  build-linux:
    name: Native Linux Build
    runs-on: ubuntu-24.04
    needs: build-docker

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build git pkg-config \
                                   libboost-all-dev libeigen3-dev wget unzip

      # ----------------------------------------------------------
      # OR-Tools cache
      # ----------------------------------------------------------
      - name: Cache OR-Tools build
        id: cache_ortools
        uses: actions/cache@v4
        with:
          path: ortools-install
          key: ortools-linux-v9.6-${{ hashFiles('**/CMakeLists.txt') }}

      - name: Build OR-Tools from source (if cache miss)
        if: steps.cache_ortools.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/google/or-tools.git --branch v9.6 --depth 1
          mkdir ortools-build
          cd ortools-build
          cmake ../or-tools \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_DEPS=ON \
            -DBUILD_TESTING=OFF \
            -S ../or-tools \
            -B ./
          cmake --build . --config Release -j$(nproc)
          cmake --install . --prefix ../ortools-install

      # ----------------------------------------------------------
      # Build your project!
      # ----------------------------------------------------------
      - name: Build your project
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release \
                -Dortools_DIR=$GITHUB_WORKSPACE/ortools-install/lib/cmake/ortools
          cmake --build build --target oblivious_routing -j$(nproc)

      - name: Upload Linux binary
        uses: actions/upload-artifact@v4
        with:
          name: oblivious_routing-linux
          path: build/oblivious_routing



  # ================================================================
  # 3) macOS BUILD
  # ================================================================
  build-macos:
    name: Native macOS Build
    runs-on: macos-latest
    needs: build-docker

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install deps
        run: |
          brew update
          brew install cmake eigen boost git ninja libomp
          echo "CPPFLAGS=-I/usr/local/opt/libomp/include" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/opt/libomp/lib" >> $GITHUB_ENV

      # ---------------------------------------------------
      # Proper OR-Tools cache
      # ---------------------------------------------------
      - name: Cache OR-Tools
        id: cache_ortools
        uses: actions/cache@v4
        with:
          path: ortools-install
          key: ortools-macos-v9.6

      # ---------------------------------------------------
      # Build OR-Tools if cache missing or empty
      # ---------------------------------------------------
      - name: Build OR-Tools from source
        if: steps.cache_ortools_macos.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/google/or-tools.git --depth 1
          mkdir ortools-build
          cd ortools-build

          cmake ../or-tools \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_DEPS=OFF \        # ← KEY FIX
            -DBUILD_TESTING=OFF \
            -DUSE_OPENMP=OFF

          cmake --build . --config Release -j$(sysctl -n hw.ncpu)
          cmake --install . --prefix ../ortools-install
      

      # ---------------------------------------------------
      # Build your project
      # ---------------------------------------------------
      - name: Build oblivious_routing
        run: |
          PREFIX=$(pwd)/ortools-install/lib/cmake/ortools
          echo "Using OR-Tools DIR: $PREFIX"

          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -Dortools_DIR=$PREFIX \
            -DUSE_OPENMP=OFF

          cmake --build build --target oblivious_routing -j4

      - name: Upload macOS binary
        uses: actions/upload-artifact@v4
        with:
          name: oblivious_routing-macos
          path: build/oblivious_routing



  # ================================================================
  # 4) WINDOWS BUILD (.exe)
  # ================================================================
  build-windows:
    name: Native Windows Build
    runs-on: windows-latest
    needs: build-docker

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install C++ build tools
        shell: pwsh
        run: |
          choco install cmake ninja git -y

      - name: Cache OR-Tools
        id: cache_ortools_win
        uses: actions/cache@v4
        with:
          path: ortools-install
          key: ortools-windows-master-${{ hashFiles('**/CMakeLists.txt') }}

      - name: Build OR-Tools from source
        if: steps.cache_ortools_win.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          git clone https://github.com/google/or-tools.git --depth 1  # ← master branch
          mkdir ortools-build
          cd ortools-build
          cmake ../or-tools `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_DEPS=OFF `
            -DBUILD_TESTING=OFF `
            -DUSE_OPENMP=OFF `
            -A x64
          cmake --build . --config Release -j4
          cmake --install . --prefix ../ortools-install

      - name: Build your project
        shell: pwsh
        run: |
          cmake -S . -B build -A x64 -DCMAKE_BUILD_TYPE=Release `
                -Dortools_DIR="$PWD\ortools-install\lib\cmake\ortools" `
                -DUSE_OPENMP=OFF
          cmake --build build --target oblivious_routing --config Release

      - name: Upload Windows EXE
        uses: actions/upload-artifact@v4
        with:
          name: oblivious_routing-windows
          path: build/Release/oblivious_routing.exe




  # ================================================================
  # 5) OPTIONAL: CREATE GITHUB RELEASE WHEN TAGGING
  # ================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos, build-windows]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all binaries
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            oblivious_routing-linux/oblivious_routing
            oblivious_routing-macos/oblivious_routing
            oblivious_routing-windows/oblivious_routing.exe
